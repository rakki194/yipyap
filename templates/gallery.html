{% extends "base.html" %}

{% block content %}
<div class="controls">
    <div class="filters">
        <input 
            type="text" 
            name="search" 
            placeholder="Search..."
            hx-trigger="keyup changed delay:500ms"
            hx-get="/{{ current_path }}"
            hx-target="#gallery"
            hx-include="[name='view-mode'],[name='sort-by']"
            value="{{ current_search or '' }}"
        >
        <select 
            name="view-mode"
            hx-get="/{{ current_path }}"
            hx-target="#gallery"
            hx-include="[name='search'],[name='sort-by']"
        >
            <option value="grid" {% if view_mode == 'grid' %}selected{% endif %}>Grid</option>
            <option value="list" {% if view_mode == 'list' %}selected{% endif %}>List</option>
        </select>
        <select 
            name="sort-by"
            hx-get="/{{ current_path }}"
            hx-target="#gallery"
            hx-include="[name='search'],[name='view-mode']"
        >
            <option value="name" {% if current_sort == 'name' %}selected{% endif %}>Name</option>
            <option value="date" {% if current_sort == 'date' %}selected{% endif %}>Modified</option>
            <option value="size" {% if current_sort == 'size' %}selected{% endif %}>Size</option>
        </select>
    </div>
</div>

<div id="gallery" class="gallery {% if view_mode == 'list' %}list-view{% endif %}">
    {% if parent_path != current_path and current_path != '' %}
    <div class="item directory">
        <a href="/{{ parent_path }}" class="directory-link">
            <i class="ri-arrow-up-line"></i>
            <span>..</span>
        </a>
    </div>
    {% endif %}

    <div class="responsive-grid">
        {% for item in items %}
            {% if item.type == 'directory' %}
            <div class="item directory">
                <a href="/{{ item.path }}" class="directory-link">
                    <i class="ri-folder-line"></i>
                    <span>{{ item.name }}</span>
                </a>
            </div>
            {% else %}
            <div class="item image" 
                 hx-get="/{{ item.path }}" 
                 hx-target="#image-modal" 
                 hx-trigger="click"
                 data-aspect-ratio="{{ item.aspect_ratio }}">
                <div class="thumbnail-wrapper" style="--aspect-ratio: {{ item.aspect_ratio }}; min-height: 100px; position: relative;">
                    <img src="/thumbnail/{{ item.thumbnail_path }}" 
                         alt="{{ item.name }}"
                         loading="lazy"
                         width="{{ item.thumbnail_width }}"
                         height="{{ item.thumbnail_height }}"
                         style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
                </div>
                <div class="info">
                    <div class="name">{{ item.name }}</div>
                    <div class="meta">{{ item.size|filesizeformat }}</div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<div id="image-modal" class="modal"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const grid = document.querySelector('.responsive-grid');
        if (grid) {
            const resizeObserver = new ResizeObserver(entries => {
                for (const entry of entries) {
                    const width = entry.contentRect.width;
                    const minWidth = 200; // Minimum width for grid items
                    const gap = 16; // Matches CSS gap
                    const columns = Math.max(1, Math.floor((width + gap) / (minWidth + gap)));
                    
                    // Update CSS custom property
                    grid.style.setProperty('--columns', columns);
                    
                    // Calculate optimal item width
                    const itemWidth = (width - (gap * (columns - 1))) / columns;
                    grid.style.setProperty('--item-width', `${itemWidth}px`);
                }
            });
            
            resizeObserver.observe(grid);
        }


        document.querySelectorAll('.thumbnail-wrapper img').forEach(img => {
            if (!img.complete) {
                img.addEventListener('load', function() {
                    this.classList.add('loaded');
                    this.removeEventListener('load', arguments.callee);
                });
            } else {
                console.log('already loaded:', img);
                img.classList.add('loaded');
            }
        });
    });
</script>
{% endblock %}
